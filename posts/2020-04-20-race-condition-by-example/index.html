<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Race Condition by example - Raghavendra Kaushik</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Consider the following code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  #include <stdio.h> #include <pthread.h> #define NUM_THREADS 4 void *threadFunc(void *pArg) { /* thread main */ int *p = (int*)pArg; int myNum = *p; printf(&#34;Thread number %d\n&#34;, myNum); return 0; } int main(void) { int i; pthread_t tid[NUM_THREADS]; for(i = 0; i < NUM_THREADS; i++) { /* create/fork threads */ pthread_create(&tid[i], NULL, threadFunc, &i); } for(i = 0; i < NUM_THREADS; i++) { /* wait/join threads */ pthread_join(tid[i], NULL); } return 0; }   In the above example, one would normally expect that the output of the program would be"><meta property="og:image" content><meta property="og:title" content="Race Condition by example"><meta property="og:description" content="Consider the following code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  #include <stdio.h> #include <pthread.h> #define NUM_THREADS 4 void *threadFunc(void *pArg) { /* thread main */ int *p = (int*)pArg; int myNum = *p; printf(&#34;Thread number %d\n&#34;, myNum); return 0; } int main(void) { int i; pthread_t tid[NUM_THREADS]; for(i = 0; i < NUM_THREADS; i++) { /* create/fork threads */ pthread_create(&tid[i], NULL, threadFunc, &i); } for(i = 0; i < NUM_THREADS; i++) { /* wait/join threads */ pthread_join(tid[i], NULL); } return 0; }   In the above example, one would normally expect that the output of the program would be"><meta property="og:type" content="article"><meta property="og:url" content="https://rakaar.github.io/posts/2020-04-20-race-condition-by-example/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-20T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Race Condition by example"><meta name=twitter:description content="Consider the following code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  #include <stdio.h> #include <pthread.h> #define NUM_THREADS 4 void *threadFunc(void *pArg) { /* thread main */ int *p = (int*)pArg; int myNum = *p; printf(&#34;Thread number %d\n&#34;, myNum); return 0; } int main(void) { int i; pthread_t tid[NUM_THREADS]; for(i = 0; i < NUM_THREADS; i++) { /* create/fork threads */ pthread_create(&tid[i], NULL, threadFunc, &i); } for(i = 0; i < NUM_THREADS; i++) { /* wait/join threads */ pthread_join(tid[i], NULL); } return 0; }   In the above example, one would normally expect that the output of the program would be"><script src=https://rakaar.github.iojs/feather.min.js></script><link href=https://rakaar.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://rakaar.github.io/css/main.5a5ffad9e55591a3e4fcebdb9ed3807c781cabfdb4de3dcf89a187a9f18d9bd9.css></head><body><div class=content><header><div class=main><a href=https://rakaar.github.io>Raghavendra Kaushik</a></div><nav><a href=/>Home</a>
<a href=/posts>Blog</a>
<a href=/about>About</a>
<a href=/tags>Tags</a>
<a href=/credits>Credits</a></nav></header><main><article><div class=title><h1 class=title>Race Condition by example</h1><div class=meta>Posted on Apr 20, 2020</div></div><section class=body><h3 id=consider-the-following-code>Consider the following code</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;

#define NUM_THREADS 4

void *threadFunc(void *pArg) { /* thread main */
	int *p = (int*)pArg;
	int myNum = *p;
	printf(&#34;Thread number %d\n&#34;, myNum);
	return 0;
}

int main(void) {
	int i;
	pthread_t tid[NUM_THREADS];
	
	for(i = 0; i &lt; NUM_THREADS; i++) { /* create/fork threads */
		pthread_create(&amp;tid[i], NULL, threadFunc, &amp;i);
	}
	
	for(i = 0; i &lt; NUM_THREADS; i++) { /* wait/join threads */
		pthread_join(tid[i], NULL);
	}
	return 0;
}
</code></pre></td></tr></table></div></div><p>In the above example, one would normally expect that the output of the program would be</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Thread Number 0
Thread Number 1
Thread Number 2
Thread Number 3
</code></pre></td></tr></table></div></div><p>Or the above in a jumbled order because we cannot guarantee the order of execution of print.
Now there is also this condition possible where we can expect a result something like this</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Thread Number 0
Thread Number 2
Thread Number 2
Thread Number 3
</code></pre></td></tr></table></div></div><p>Now how is that possible ?</p><p>The main reason is that the variable i is available for change even while its value is being read.
In detail, suppose we reach a condition where i = 1 ; and <code>threadFunc</code> starts getting exectuted.
As per the code of <code>threadFunc</code>, the <code>pointer p</code> is assigned the value of address of <code>i</code>, and variable <code>myNum</code> is being assigned the value of variable whose address is stored by <code>p pointer</code>, which we expect to be value of <code>i</code>, and hence you expect Thread Number 1 to be printed.
But here before printing that, the value of <code>i</code> has been changed by the <code>main</code> thread to 2 by incrementing it. So when you are expecting that you are assigning 1 to <code>myNum</code> because <code>p</code> contains address of <code>i</code>, whose value is 1, is actually no longer 1 but has been incremented to 2; by the <code>main thread</code>.</p><p>This is called Data Race or Race condition where a variable is being read by one thread, and the variable&rsquo;s value is being written(altered) by other thread.
Now how do we avoid it
Store it in a variable(an array preferably here) which isn&rsquo;t altered and pass it as argument in pthread_create. Because though i will be altered the value which we want has been copied into a array cell which is not going to be changed. The code would be in this manner:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;

#define NUM_THREADS 4

void *threadFunc(void *pArg) { /* thread main */
	int myNum = *((int*)pArg);
	printf(&#34;Thread number %d\n&#34;, myNum);
	return 0;
}

int main(void) {

	int i;
	int tNum[NUM_THREADS];
	pthread_t tid[NUM_THREADS];
	
	for(i = 0; i &lt; NUM_THREADS; i++) { /* create/fork threads */
		tNum[i] = i;
		pthread_create(&amp;tid[i], NULL, threadFunc, &amp;tNum[i]);
	}
	
	for(i = 0; i &lt; NUM_THREADS; i++) { /* wait/join threads */
		pthread_join(tid[i], NULL);
	}

	return 0;
}
</code></pre></td></tr></table></div></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/os>OS</a></li><li><a href=/tags/threads>threads</a></li><li><a href=/tags/concurrency>Concurrency</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://rakaar.github.io/index.xml title=RSS><i data-feather=rss></i></a>|<a class=soc href=mailto:rka87338@gmail.com title=Email><i data-feather=mail></i></a>|<a class=soc href=https://github.com/rakaar title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/raghavendrakau9 title=Twitter><i data-feather=twitter></i></a>|⚡️
2021 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>